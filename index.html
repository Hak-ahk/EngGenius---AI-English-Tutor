<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EngGenius - AI Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- React & Babel CDNs for standalone execution -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google GenAI SDK (ES Module) - handled via importmap for browser -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>

    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
      .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenAI } from "@google/genai";
      
      const { useState, useEffect, useRef } = React;

      // --- CONFIG & SERVICES ---
      
      const Difficulty = {
        EASY: 'Easy (Dễ)',
        MEDIUM: 'Medium (Trung bình)',
        ADVANCED: 'Advanced (Nâng cao)'
      };

      // Helper: Get API Key from LocalStorage
      const getApiKey = () => localStorage.getItem('GEMINI_API_KEY') || '';

      // Helper: Convert Audio Blob to Base64
      const blobToBase64 = (blob) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      };

      // Service: Generate Answer
      const generateAnswer = async (question, difficulty) => {
        const apiKey = getApiKey();
        if (!apiKey) throw new Error("MISSING_KEY");

        const ai = new GoogleGenAI({ apiKey });
        const model = "gemini-2.5-flash";
        
        const prompt = `
          You are an expert English tutor.
          User asks: "${question}".
          Generate an answer in English (Level: ${difficulty}).
          
          Return JSON format:
          {
            "english": "Full English answer",
            "vietnamese": "Vietnamese translation of full answer",
            "sentences": [
              { "english": "Sentence 1", "vietnamese": "Translation 1" },
              { "english": "Sentence 2", "vietnamese": "Translation 2" }
            ]
          }
        `;

        const response = await ai.models.generateContent({
          model,
          contents: prompt,
          config: { responseMimeType: "application/json" }
        });

        return JSON.parse(response.text);
      };

      // Service: Check Pronunciation
      const checkPronunciation = async (audioBase64, targetText) => {
        const apiKey = getApiKey();
        if (!apiKey) return "Vui lòng nhập API Key để dùng tính năng này.";

        const ai = new GoogleGenAI({ apiKey });
        const response = await ai.models.generateContent({
          model: "gemini-2.5-flash",
          contents: {
            parts: [
              { inlineData: { mimeType: "audio/wav", data: audioBase64 } },
              { text: `Listen to this audio. User is reading: "${targetText}". Give feedback in Vietnamese about pronunciation/fluency.` }
            ]
          }
        });
        return response.text;
      };

      // --- COMPONENTS ---

      // 1. API Key Modal
      const ApiKeyModal = ({ isOpen, onClose }) => {
        const [key, setKey] = useState('');

        if (!isOpen) return null;

        const handleSave = () => {
          if(key.trim()) {
            localStorage.setItem('GEMINI_API_KEY', key.trim());
            onClose();
          }
        };

        return (
          <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md animate-fade-in-up">
              <h2 className="text-xl font-bold text-gray-800 mb-2">Cấu hình API Key</h2>
              <p className="text-sm text-gray-600 mb-4">
                Ứng dụng cần <b>Gemini API Key</b> để tạo nội dung và nghe giọng nói (Giọng đọc hệ thống miễn phí, nhưng trí tuệ nhân tạo thì cần Key).
              </p>
              <input 
                type="password" 
                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 mb-4"
                placeholder="Dán API Key vào đây (AIza...)"
                value={key}
                onChange={e => setKey(e.target.value)}
              />
              <button 
                onClick={handleSave}
                disabled={!key}
                className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50"
              >
                Lưu và Bắt đầu
              </button>
              <div className="mt-4 text-center">
                 <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-indigo-600 underline">Lấy API Key miễn phí tại đây</a>
              </div>
            </div>
          </div>
        );
      };

      // 2. Practice Modal (Recording)
      const PracticeModal = ({ isOpen, onClose, targetText, type }) => {
        const [status, setStatus] = useState('idle'); // idle, recording, analyzing, done
        const [feedback, setFeedback] = useState('');
        const mediaRecorderRef = useRef(null);
        const chunksRef = useRef([]);

        if (!isOpen) return null;

        const startRecording = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorderRef.current = mediaRecorder;
            chunksRef.current = [];

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
            mediaRecorder.onstop = async () => {
              setStatus('analyzing');
              const blob = new Blob(chunksRef.current, { type: 'audio/wav' });
              try {
                const base64 = await blobToBase64(blob);
                const result = await checkPronunciation(base64, targetText);
                setFeedback(result);
                setStatus('done');
              } catch (e) {
                setFeedback("Lỗi phân tích: " + e.message);
                setStatus('done');
              }
              stream.getTracks().forEach(t => t.stop());
            };

            mediaRecorder.start();
            setStatus('recording');
          } catch (err) {
            alert("Không thể truy cập Microphone");
          }
        };

        const stopRecording = () => {
          if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
        };

        return (
          <div className="fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 animate-fade-in-up max-h-[90vh] flex flex-col">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg">Luyện nói: {type === 'question' ? 'Câu hỏi' : 'Câu trả lời'}</h3>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">✕</button>
              </div>
              
              <div className="overflow-y-auto flex-1">
                <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-6">
                  <p className="text-indigo-900 font-medium text-lg">{targetText}</p>
                </div>

                <div className="flex justify-center mb-6">
                   {status === 'analyzing' ? (
                     <div className="flex flex-col items-center text-indigo-600">
                        <div className="spinner border-indigo-600 border-t-transparent mb-2"></div>
                        <span>Đang chấm điểm...</span>
                     </div>
                   ) : (
                     <button 
                      onClick={status === 'recording' ? stopRecording : startRecording}
                      className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${status === 'recording' ? 'bg-red-500 scale-110 shadow-red-200 shadow-xl' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg'}`}
                     >
                        {status === 'recording' ? (
                          <div className="w-8 h-8 bg-white rounded"></div>
                        ) : (
                          <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        )}
                     </button>
                   )}
                </div>

                {feedback && (
                  <div className="bg-green-50 p-4 rounded-lg border border-green-200 text-sm text-gray-800">
                    <strong className="text-green-800 block mb-1">AI Feedback:</strong>
                    {feedback}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const [question, setQuestion] = useState('');
        const [difficulty, setDifficulty] = useState(Difficulty.MEDIUM);
        const [result, setResult] = useState(null);
        const [loading, setLoading] = useState(false);
        const [showKeyModal, setShowKeyModal] = useState(false);
        
        // TTS State
        const [voices, setVoices] = useState([]);
        const [ttsConfig, setTtsConfig] = useState({ voiceURI: '', speed: 1.0 });
        const [speakingId, setSpeakingId] = useState(null);

        // Practice State
        const [practiceData, setPracticeData] = useState({ isOpen: false, text: '', type: 'question' });

        // Init Check
        useEffect(() => {
          if (!getApiKey()) setShowKeyModal(true);

          // Load Voices
          const loadVoices = () => {
            const all = window.speechSynthesis.getVoices();
            const en = all.filter(v => v.lang.startsWith('en'));
            const list = en.length > 0 ? en : all;
            setVoices(list);
            if (list.length > 0 && !ttsConfig.voiceURI) {
              const pref = list.find(v => v.name.includes('Google US')) || list[0];
              setTtsConfig(prev => ({ ...prev, voiceURI: pref.voiceURI }));
            }
          };
          loadVoices();
          window.speechSynthesis.onvoiceschanged = loadVoices;
        }, []);

        const handleGenerate = async () => {
          if (!getApiKey()) { setShowKeyModal(true); return; }
          setLoading(true);
          window.speechSynthesis.cancel();
          try {
            const res = await generateAnswer(question, difficulty);
            setResult(res);
          } catch (err) {
            console.error(err);
            if (err.message === "MISSING_KEY") setShowKeyModal(true);
            else alert("Lỗi khi tạo câu trả lời. Vui lòng thử lại.");
          } finally {
            setLoading(false);
          }
        };

        const speak = (text, id) => {
          window.speechSynthesis.cancel();
          if (speakingId === id) {
            setSpeakingId(null);
            return;
          }
          const u = new SpeechSynthesisUtterance(text);
          const v = voices.find(vo => vo.voiceURI === ttsConfig.voiceURI);
          if (v) u.voice = v;
          u.rate = ttsConfig.speed;
          u.onend = () => setSpeakingId(null);
          setSpeakingId(id);
          window.speechSynthesis.speak(u);
        };

        return (
          <div className="min-h-screen p-4 md:p-8">
            <ApiKeyModal isOpen={showKeyModal} onClose={() => setShowKeyModal(false)} />
            
            <header className="text-center mb-8">
              <h1 className="text-4xl font-extrabold text-indigo-900">Eng<span className="text-indigo-600">Genius</span></h1>
              <p className="text-gray-500">Hệ thống TTS + Gemini AI</p>
            </header>

            <div className="max-w-4xl mx-auto space-y-6">
              {/* Input Section */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <textarea 
                  value={question}
                  onChange={e => setQuestion(e.target.value)}
                  className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 mb-4 min-h-[100px]"
                  placeholder="Nhập câu hỏi tiếng Anh của bạn (VD: Tell me about your hobby)..."
                />
                
                <div className="flex flex-col sm:flex-row justify-between gap-4">
                  <div className="flex gap-2 w-full sm:w-auto">
                    <select 
                      value={difficulty} 
                      onChange={e => setDifficulty(e.target.value)}
                      className="p-3 bg-white border border-gray-300 rounded-lg text-sm w-full"
                    >
                      {Object.values(Difficulty).map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                    {/* Re-open Key Modal */}
                    <button onClick={() => setShowKeyModal(true)} className="p-3 text-gray-400 hover:text-indigo-600 border rounded-lg" title="Cài đặt API Key">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                  </div>

                  <button 
                    onClick={handleGenerate} 
                    disabled={loading || !question.trim()}
                    className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center gap-2 w-full sm:w-auto"
                  >
                    {loading ? <div className="spinner"></div> : <span>Tạo câu trả lời</span>}
                  </button>
                </div>
              </div>

              {/* TTS Controls */}
              {result && (
                <div className="bg-white p-4 rounded-xl border flex flex-wrap gap-4 items-center justify-between">
                  <div className="flex items-center gap-2 w-full sm:w-auto">
                    <span className="text-sm font-bold text-gray-500">Giọng đọc:</span>
                    <select 
                      className="p-2 border rounded-lg text-sm max-w-[200px]"
                      value={ttsConfig.voiceURI}
                      onChange={e => setTtsConfig({...ttsConfig, voiceURI: e.target.value})}
                    >
                      {voices.map(v => <option key={v.voiceURI} value={v.voiceURI}>{v.name}</option>)}
                    </select>
                  </div>
                  <div className="flex items-center gap-2 w-full sm:w-auto">
                    <span className="text-sm font-bold text-gray-500">Tốc độ: {ttsConfig.speed}x</span>
                    <input 
                      type="range" min="0.5" max="2" step="0.1" 
                      value={ttsConfig.speed}
                      onChange={e => setTtsConfig({...ttsConfig, speed: Number(e.target.value)})}
                      className="w-32 accent-indigo-600"
                    />
                  </div>
                </div>
              )}

              {/* Results Display */}
              {result && (
                <div className="animate-fade-in-up space-y-6">
                  {/* Full Answer */}
                  <div className="bg-white rounded-2xl shadow-lg border-l-4 border-indigo-500 p-6 md:p-8">
                     <div className="flex justify-between items-start mb-4">
                        <h2 className="text-xl font-bold">Câu trả lời mẫu</h2>
                        <div className="flex gap-2">
                           <button onClick={() => speak(result.english, 'full')} className={`p-2 rounded-full ${speakingId === 'full' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100'}`}>
                             <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d={speakingId === 'full' ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z"}/></svg>
                           </button>
                           <button onClick={() => setPracticeData({isOpen: true, text: result.english, type: 'answer'})} className="p-2 rounded-full bg-green-50 text-green-600">
                             <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                           </button>
                        </div>
                     </div>
                     <p className="text-lg text-gray-800 font-medium leading-relaxed">{result.english}</p>
                     <p className="text-gray-500 italic mt-4 border-t pt-2">{result.vietnamese}</p>
                  </div>

                  {/* Sentences */}
                  <div className="space-y-3">
                    <h3 className="font-bold text-gray-700">Chi tiết từng câu</h3>
                    {result.sentences.map((s, idx) => (
                      <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-indigo-300 transition-all flex gap-4">
                        <div className="flex flex-col gap-2 shrink-0">
                           <button onClick={() => speak(s.english, idx)} className={`p-2 rounded-lg ${speakingId === idx ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-600'}`}>
                             <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d={speakingId === idx ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z"}/></svg>
                           </button>
                           <button onClick={() => setPracticeData({isOpen: true, text: s.english, type: 'sentence'})} className="p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-600">
                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                           </button>
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">{s.english}</p>
                          <p className="text-sm text-gray-500 italic">{s.vietnamese}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <PracticeModal 
              isOpen={practiceData.isOpen} 
              onClose={() => setPracticeData({...practiceData, isOpen: false})} 
              targetText={practiceData.text} 
              type={practiceData.type}
            />
          </div>
        );
      };

      // --- MOUNT ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
