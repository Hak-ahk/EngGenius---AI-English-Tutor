<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EngGenius - Học Tiếng Anh cùng AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google GenAI SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>

    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
      .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenAI } from "@google/genai";
      
      const { useState, useEffect, useRef } = React;

      // =========================================================================================
      // CẤU HÌNH BẢO MẬT (MÃ HÓA BASE64)
      // 1. Vào trang https://www.base64encode.org/
      // 2. Dán API Key gốc của bạn vào (Ví dụ: AIzaSy...)
      // 3. Nhấn ENCODE, copy chuỗi kết quả (Ví dụ: QUl6YVN5...)
      // 4. Dán chuỗi kết quả vào biến ENCODED_KEY bên dưới.
      // =========================================================================================
      const ENCODED_KEY = 'PASTE_YOUR_BASE64_ENCODED_KEY_HERE'; 
      
      // Hàm giải mã key an toàn hơn
      const getApiKey = () => {
        try {
          if (!ENCODED_KEY || ENCODED_KEY.includes('PASTE_YOUR')) return '';
          return atob(ENCODED_KEY);
        } catch (e) {
          console.error("Lỗi giải mã Key:", e);
          return '';
        }
      };

      // --- CONFIG ---
      const Difficulty = {
        EASY: 'Easy (Dễ)',
        MEDIUM: 'Medium (Trung bình)',
        ADVANCED: 'Advanced (Nâng cao)'
      };

      // --- HELPERS ---
      const blobToBase64 = (blob) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      };

      // --- SERVICES ---
      const generateAnswer = async (question, difficulty) => {
        const apiKey = getApiKey();
        if (!apiKey) {
            alert("⚠️ LỖI CẤU HÌNH: Bạn chưa điền Key đã mã hóa (Encoded Key) vào code.");
            throw new Error("Missing Key");
        }

        const ai = new GoogleGenAI({ apiKey });
        const model = "gemini-2.5-flash";
        const prompt = `
          You are an expert English tutor.
          User asks: "${question}".
          Generate an answer in English (Level: ${difficulty}).
          
          Return JSON format:
          {
            "english": "Full English answer",
            "vietnamese": "Vietnamese translation of full answer",
            "sentences": [
              { "english": "Sentence 1", "vietnamese": "Translation 1" },
              { "english": "Sentence 2", "vietnamese": "Translation 2" }
            ]
          }
        `;

        const response = await ai.models.generateContent({
          model,
          contents: prompt,
          config: { responseMimeType: "application/json" }
        });

        return JSON.parse(response.text);
      };

      const checkPronunciation = async (audioBase64, targetText) => {
        const apiKey = getApiKey();
        if (!apiKey) return "Lỗi: Chưa cấu hình API Key.";
        
        const ai = new GoogleGenAI({ apiKey });
        const response = await ai.models.generateContent({
          model: "gemini-2.5-flash",
          contents: {
            parts: [
              { inlineData: { mimeType: "audio/wav", data: audioBase64 } },
              { text: `Listen to this audio. User is reading: "${targetText}". Give brief feedback in Vietnamese about pronunciation/fluency.` }
            ]
          }
        });
        return response.text;
      };

      // --- COMPONENTS ---

      // 1. Practice Modal (Recording)
      const PracticeModal = ({ isOpen, onClose, targetText, type }) => {
        const [status, setStatus] = useState('idle'); // idle, recording, analyzing, done
        const [feedback, setFeedback] = useState('');
        const mediaRecorderRef = useRef(null);
        const chunksRef = useRef([]);

        if (!isOpen) return null;

        const startRecording = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorderRef.current = mediaRecorder;
            chunksRef.current = [];

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
            mediaRecorder.onstop = async () => {
              setStatus('analyzing');
              const blob = new Blob(chunksRef.current, { type: 'audio/wav' });
              try {
                const base64 = await blobToBase64(blob);
                const result = await checkPronunciation(base64, targetText);
                setFeedback(result);
                setStatus('done');
              } catch (e) {
                setFeedback("Lỗi: " + e.message);
                setStatus('done');
              }
              stream.getTracks().forEach(t => t.stop());
            };

            mediaRecorder.start();
            setStatus('recording');
          } catch (err) {
            alert("Không thể truy cập Microphone. Hãy kiểm tra quyền truy cập trình duyệt.");
          }
        };

        const stopRecording = () => {
          if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
        };

        return (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 animate-fade-in-up max-h-[90vh] flex flex-col">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg text-gray-800">Luyện nói</h3>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">✕</button>
              </div>
              
              <div className="overflow-y-auto flex-1">
                <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-6">
                  <p className="text-indigo-900 font-medium text-lg leading-snug">{targetText}</p>
                </div>

                <div className="flex justify-center mb-6">
                   {status === 'analyzing' ? (
                     <div className="flex flex-col items-center text-indigo-600">
                        <div className="spinner border-indigo-600 border-t-transparent mb-2"></div>
                        <span>AI đang nghe...</span>
                     </div>
                   ) : (
                     <button 
                      onClick={status === 'recording' ? stopRecording : startRecording}
                      className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${status === 'recording' ? 'bg-red-500 scale-110 shadow-red-200 shadow-xl' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg'}`}
                     >
                        {status === 'recording' ? (
                          <div className="w-8 h-8 bg-white rounded animate-pulse"></div>
                        ) : (
                          <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        )}
                     </button>
                   )}
                </div>
                
                <p className="text-center text-sm text-gray-500 mb-4">
                    {status === 'recording' ? "Đang ghi âm... Bấm để dừng" : status === 'analyzing' ? "" : "Bấm micro để đọc câu trên"}
                </p>

                {feedback && (
                  <div className="bg-green-50 p-4 rounded-lg border border-green-200 text-sm text-gray-800 animate-fade-in-up">
                    <strong className="text-green-800 block mb-1">Đánh giá:</strong>
                    {feedback}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const [question, setQuestion] = useState('');
        const [difficulty, setDifficulty] = useState(Difficulty.MEDIUM);
        const [result, setResult] = useState(null);
        const [loading, setLoading] = useState(false);
        
        // TTS State
        const [voices, setVoices] = useState([]);
        const [ttsConfig, setTtsConfig] = useState({ voiceURI: '', speed: 1.0 });
        const [speakingId, setSpeakingId] = useState(null);
        // FIX: Thêm ref để giữ đối tượng âm thanh không bị browser dọn rác
        const utteranceRef = useRef(null);

        // Practice State
        const [practiceData, setPracticeData] = useState({ isOpen: false, text: '', type: 'question' });

        // Load Voices - Improved Logic
        useEffect(() => {
          const loadVoices = () => {
            const all = window.speechSynthesis.getVoices();
            if (all.length === 0) return; // Chưa tải xong

            const en = all.filter(v => v.lang.startsWith('en')); // Prefer English
            const list = en.length > 0 ? en : all;
            setVoices(list);
            
            // Auto select a good voice
            if (list.length > 0 && !ttsConfig.voiceURI) {
              const pref = list.find(v => v.name.includes('Google US')) || list[0];
              setTtsConfig(prev => ({ ...prev, voiceURI: pref.voiceURI }));
            }
          };

          loadVoices();
          window.speechSynthesis.onvoiceschanged = loadVoices;
          
          // Fallback cho một số trình duyệt không fire sự kiện onvoiceschanged ngay
          const interval = setInterval(loadVoices, 500);
          setTimeout(() => clearInterval(interval), 5000); // Thử lại trong 5 giây
          
          return () => clearInterval(interval);
        }, []);

        const handleGenerate = async () => {
          setLoading(true);
          window.speechSynthesis.cancel();
          try {
            const res = await generateAnswer(question, difficulty);
            setResult(res);
          } catch (err) {
            console.error(err);
          } finally {
            setLoading(false);
          }
        };

        const speak = (text, id) => {
          // Cancel current
          window.speechSynthesis.cancel();
          
          if (speakingId === id) {
            setSpeakingId(null);
            return;
          }

          if (!text) return;

          try {
            const u = new SpeechSynthesisUtterance(text);
            
            // FIX: Gán vào Ref để tránh lỗi Garbage Collection
            utteranceRef.current = u;

            const v = voices.find(vo => vo.voiceURI === ttsConfig.voiceURI);
            if (v) u.voice = v;
            u.rate = ttsConfig.speed;
            
            u.onend = () => {
              setSpeakingId(null);
              utteranceRef.current = null; // Clean up ref
            };
            
            u.onerror = (e) => {
              console.error("TTS Error:", e);
              setSpeakingId(null);
            };

            setSpeakingId(id);
            window.speechSynthesis.speak(u);
          } catch (e) {
            console.error("Speak failed", e);
            alert("Lỗi trình duyệt không hỗ trợ phát âm thanh này.");
          }
        };

        return (
          <div className="min-h-screen p-4 md:p-8">
            
            <header className="text-center mb-8 pt-4">
              <h1 className="text-4xl font-extrabold text-indigo-900 tracking-tight">Eng<span className="text-indigo-600">Genius</span></h1>
              <p className="text-gray-500 mt-2">Trợ lý học Tiếng Anh thông minh</p>
            </header>

            <div className="max-w-4xl mx-auto space-y-6">
              
              {/* Input Card */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Câu hỏi của bạn</label>
                <textarea 
                  value={question}
                  onChange={e => setQuestion(e.target.value)}
                  className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 mb-4 min-h-[100px] text-gray-800"
                  placeholder="Ví dụ: Describe your daily routine..."
                />
                
                <div className="flex flex-col sm:flex-row justify-between gap-4">
                  <div className="w-full sm:w-auto">
                    <select 
                      value={difficulty} 
                      onChange={e => setDifficulty(e.target.value)}
                      className="p-3 bg-white border border-gray-300 rounded-lg text-sm w-full font-medium"
                    >
                      {Object.values(Difficulty).map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                  </div>

                  <button 
                    onClick={handleGenerate} 
                    disabled={loading || !question.trim()}
                    className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center gap-2 w-full sm:w-auto shadow-md hover:shadow-lg transition-all"
                  >
                    {loading ? <div className="spinner"></div> : (
                      <>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        <span>Tạo câu trả lời</span>
                      </>
                    )}
                  </button>
                </div>
              </div>

              {/* TTS Controls (Only show if result) */}
              {result && (
                <div className="bg-white p-4 rounded-xl border flex flex-wrap gap-4 items-center justify-between">
                  <div className="flex items-center gap-2 w-full sm:w-auto flex-1">
                    <span className="text-sm font-bold text-gray-500 whitespace-nowrap">Giọng đọc ({voices.length}):</span>
                    <select 
                      className="p-2 border rounded-lg text-sm w-full bg-gray-50"
                      value={ttsConfig.voiceURI}
                      onChange={e => setTtsConfig({...ttsConfig, voiceURI: e.target.value})}
                    >
                      {voices.length === 0 && <option>Đang tải giọng...</option>}
                      {voices.map(v => <option key={v.voiceURI} value={v.voiceURI}>{v.name}</option>)}
                    </select>
                  </div>
                  <div className="flex items-center gap-2 w-full sm:w-auto">
                    <span className="text-sm font-bold text-gray-500 whitespace-nowrap">Tốc độ: {ttsConfig.speed}x</span>
                    <input 
                      type="range" min="0.5" max="2" step="0.1" 
                      value={ttsConfig.speed}
                      onChange={e => setTtsConfig({...ttsConfig, speed: Number(e.target.value)})}
                      className="w-24 accent-indigo-600"
                    />
                  </div>
                </div>
              )}

              {/* Results Display */}
              {result && (
                <div className="animate-fade-in-up space-y-6">
                  {/* Full Answer */}
                  <div className="bg-white rounded-2xl shadow-lg border-l-4 border-indigo-500 p-6 md:p-8">
                     <div className="flex justify-between items-start mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Câu trả lời hoàn chỉnh</h2>
                        <div className="flex gap-2">
                           <button 
                             onClick={() => speak(result.english, 'full')} 
                             className={`p-2 rounded-full transition-colors ${speakingId === 'full' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-600 hover:bg-indigo-100'}`}
                             title="Nghe toàn bài"
                           >
                             <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d={speakingId === 'full' ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z"}/></svg>
                           </button>
                           <button 
                             onClick={() => setPracticeData({isOpen: true, text: result.english, type: 'answer'})} 
                             className="p-2 rounded-full bg-green-50 text-green-600 hover:bg-green-100 transition-colors"
                             title="Luyện nói"
                           >
                             <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                           </button>
                        </div>
                     </div>
                     <p className="text-lg text-gray-900 font-medium leading-relaxed">{result.english}</p>
                     <p className="text-gray-500 italic mt-4 border-t pt-4">{result.vietnamese}</p>
                  </div>

                  {/* Sentences */}
                  <div className="space-y-3">
                    <h3 className="font-bold text-gray-700 ml-1">Chi tiết từng câu</h3>
                    {result.sentences.map((s, idx) => (
                      <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-indigo-300 transition-all flex gap-4 items-start">
                        <div className="flex flex-col gap-2 shrink-0 pt-1">
                           <button 
                            onClick={() => speak(s.english, idx)} 
                            className={`p-2 rounded-lg transition-colors ${speakingId === idx ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-600 hover:text-indigo-600'}`}
                           >
                             <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d={speakingId === idx ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z"}/></svg>
                           </button>
                           <button 
                            onClick={() => setPracticeData({isOpen: true, text: s.english, type: 'sentence'})} 
                            className="p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-600"
                           >
                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                           </button>
                        </div>
                        <div className="flex-1">
                          <p className="font-medium text-gray-900 text-lg">{s.english}</p>
                          <p className="text-sm text-gray-500 italic mt-1">{s.vietnamese}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <PracticeModal 
              isOpen={practiceData.isOpen} 
              onClose={() => setPracticeData({...practiceData, isOpen: false})} 
              targetText={practiceData.text} 
              type={practiceData.type}
            />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
